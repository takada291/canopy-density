<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>樹冠疎密</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #000;
            color: white;
        }

        /* カメラ映像 */
        #camera-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: -1;
        }

        /* 照準 */
        .crosshair-v {
            position: fixed; top: 10%; left: 50%; width: 2px; height: 80%;
            background-color: rgba(255, 255, 0, 0.8);
            transform: translateX(-50%);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        .crosshair-h {
            position: fixed; top: 50%; left: 30%; width: 40%; height: 2px;
            background-color: rgba(255, 255, 0, 0.4);
            transform: translateY(-50%);
        }

        /* ダッシュボード (測定中の情報) */
        .dashboard {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 15px 10px; box-sizing: border-box;
            background: rgba(0, 50, 0, 0.85);
            display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .dash-item { text-align: center; }
        .dash-label { font-size: 0.6rem; color: #aaa; display: block; margin-bottom:2px; }
        .dash-val { font-size: 1.1rem; font-weight: bold; color: #fff; }
        
        /* センサー情報 (HUD) */
        .hud-info {
            position: absolute; top: 80px; left: 10px;
            text-align: left; pointer-events: none;
            text-shadow: 1px 1px 2px black;
            font-family: monospace;
            font-size: 0.9rem;
            color: #00e676;
            background: rgba(0,0,0,0.3);
            padding: 5px;
            border-radius: 5px;
        }

        /* UIコンテナ共通 */
        .ui-container {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 20px; box-sizing: border-box;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
            text-align: center;
            display: none; /* JSで制御 */
        }

        /* 入力エリア */
        .input-area {
            background: rgba(255, 255, 255, 0.9);
            color: #333; padding: 10px; border-radius: 12px;
            margin-bottom: 10px; display: inline-flex; align-items: center; gap: 10px;
        }
        input[type="number"] {
            font-size: 1.2rem; padding: 5px; width: 80px; text-align: center;
            border: 1px solid #ccc; border-radius: 5px;
        }

        /* ボタン */
        button {
            width: 100%; padding: 15px; font-size: 1.1rem; font-weight: bold;
            border: none; border-radius: 50px; cursor: pointer; color: white;
            margin-bottom: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        button:active { transform: scale(0.96); }
        
        .btn-blue { background-color: #007bff; }
        .btn-orange { background-color: #e67e22; }
        .btn-green { background-color: #28a745; }
        .btn-red { background-color: #dc3545; }
        .btn-gray { background-color: #6c757d; }

        /* 結果表示画面のスタイル */
        .result-panel {
            background: white; color: #333;
            padding: 20px; border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .result-main { font-size: 3rem; font-weight: bold; color: #28a745; margin: 10px 0; }
        .result-sub { font-size: 0.9rem; color: #666; text-align: left; line-height: 1.6; }

        /* トースト */
        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); color: #fff; padding: 20px;
            border-radius: 10px; text-align: center; display: none; z-index: 100;
        }
    </style>
</head>
<body>

    <video id="camera-view" autoplay playsinline muted></video>
    <div class="crosshair-v"></div>
    <div class="crosshair-h"></div>

    <div class="hud-info" id="hud-display" style="display:none;">
        仰角: <span id="hud-pitch">0</span>°<br>
        傾き: <span id="hud-roll">0</span>°
    </div>

    <div class="dashboard" id="dashboard" style="display:none;">
        <div class="dash-item">
            <span class="dash-label">サンプル数</span>
            <span class="dash-val" id="disp-count">0</span> 本
        </div>
        <div class="dash-item">
            <span class="dash-label">平均樹冠半径</span>
            <span class="dash-val"><span id="disp-avg-r">0.00</span>m</span>
        </div>
    </div>

    <div id="start-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:999; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; box-sizing:border-box;">
        <h1>樹冠疎密 v2.0</h1>
        <p style="color:#ccc; margin-bottom:30px; font-size:0.9rem;">
            プロット内の数本で樹冠幅を測定し、<br>
            プロット内本数を掛け疎密度を計算
        </p>
        <button onclick="startApp()" class="btn-green" style="width:80%;">測定スタート</button>
        <p id="debug-log" style="font-size:0.7rem; color:red; margin-top:10px;"></p>
    </div>

    <div class="ui-container" id="ui-measure">
        <div id="current-val-box" style="margin-bottom:10px; color:#ffeb3b; font-weight:bold; display:none;">
            今回半径: <span id="current-r">0.00</span> m
        </div>

        <div class="input-area" id="input-box-dist">
            <label style="font-size:0.9rem;">対象までの水平距離:</label>
            <input type="number" id="dist-input" value="5" step="0.5"> m
        </div>

        <button id="btn-action" class="btn-blue" onclick="handleAction()">① 樹冠の左端</button>
        <button id="btn-save" class="btn-green" onclick="saveMeasurement()" style="display:none;">この値を記録する</button>
        
        <div style="margin-top:15px; border-top:1px solid rgba(255,255,255,0.3); padding-top:15px;">
            <button id="btn-next-phase" class="btn-orange" onclick="goToInputPhase()">次へ (本数入力)</button>
        </div>
    </div>

    <div class="ui-container" id="ui-input">
        <div style="background:rgba(255,255,255,0.95); color:#333; padding:20px; border-radius:15px; margin-bottom:20px;">
            <h3 style="margin-top:0;">プロット内の立木本数</h3>
            <div style="display:flex; justify-content:center; align-items:center; gap:10px;">
                <input type="number" id="total-trees-input" value="10" style="width:100px; font-size:2rem; padding:10px;">
                <span style="font-size:1.5rem; font-weight:bold;">本</span>
            </div>
            <p style="font-size:0.8rem; color:#666; margin-bottom:0;">※100㎡プロット内の総本数</p>
        </div>

        <button class="btn-green" onclick="calcResult()">計算する</button>
        <button class="btn-gray" onclick="backToMeasure()">戻る (測定継続)</button>
    </div>

    <div class="ui-container" id="ui-result">
        <div class="result-panel">
            <div>樹冠疎密度</div>
            <div class="result-main"><span id="res-density">0.0</span> %</div>
            <div class="result-sub">
                平均樹冠半径: <span id="res-avg">0.00</span> m<br>
                平均樹冠面積: <span id="res-area">0.00</span> ㎡<br>
                プロット本数: <span id="res-count">0</span> 本<br>
                <hr>
                合計樹冠面積: <span id="res-total-area">0.00</span> ㎡
            </div>
        </div>
        <button class="btn-blue" onclick="resetAll()">新しいプロットへ (最初に戻る)</button>
    </div>

    <div class="toast" id="toast">記録しました</div>

    <script>
        // 変数
        let currentAlpha = 0;
        let leftAngle = null;
        let rightAngle = null;
        let step = 0; 
        
        // データ
        let measurements = []; // 半径(m)のリスト

        // --- 起動処理 ---
        async function startApp() {
            try {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission !== 'granted') { alert("センサー不可"); return; }
                }
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('camera-view').srcObject = stream;
                window.addEventListener('deviceorientation', handleOrientation);

                // UI初期化
                document.getElementById('start-overlay').style.display = 'none';
                document.getElementById('hud-display').style.display = 'block';
                document.getElementById('dashboard').style.display = 'flex';
                showPhase('measure');
                
            } catch (err) {
                alert("起動エラー: " + err.message);
            }
        }

        // --- センサー処理 ---
        function handleOrientation(event) {
            let alpha = event.alpha; 
            if (event.webkitCompassHeading) alpha = event.webkitCompassHeading;
            if (alpha !== null) currentAlpha = alpha;

            if (event.beta !== null) {
                document.getElementById('hud-pitch').textContent = event.beta.toFixed(0);
                document.getElementById('hud-roll').textContent = event.gamma.toFixed(0);
                // 傾き警告
                document.getElementById('hud-display').style.color = Math.abs(event.gamma) > 20 ? "red" : "#00e676";
            }
        }

        // --- 測定ロジック ---
        function handleAction() {
            if (step === 0) {
                leftAngle = currentAlpha;
                step = 1;
                const btn = document.getElementById('btn-action');
                btn.textContent = "② 樹冠の右端";
                btn.className = "btn-orange";
                document.getElementById('input-box-dist').style.display = 'none';
            } else if (step === 1) {
                rightAngle = currentAlpha;
                const r = calcCurrentRadius();
                document.getElementById('current-r').textContent = r.toFixed(2);
                document.getElementById('current-val-box').style.display = 'block';
                
                document.getElementById('btn-action').style.display = 'none';
                document.getElementById('btn-save').style.display = 'block';
                step = 2;
            }
        }

        function calcCurrentRadius() {
            const distM = parseFloat(document.getElementById('dist-input').value);
            let diff = Math.abs(rightAngle - leftAngle);
            if (diff > 180) diff = 360 - diff;
            const thetaRad = diff * (Math.PI / 180);
            const diameter = 2 * distM * Math.sin(thetaRad / 2);
            return diameter / 2; // 半径を返す
        }

        function saveMeasurement() {
            const r = calcCurrentRadius();
            measurements.push(r);
            updateDashboard();

            // トースト
            const toast = document.getElementById('toast');
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 1000);

            // リセットして次へ
            step = 0;
            document.getElementById('btn-save').style.display = 'none';
            document.getElementById('current-val-box').style.display = 'none';
            
            const btn = document.getElementById('btn-action');
            btn.textContent = "① 樹冠の左端";
            btn.className = "btn-blue";
            btn.style.display = 'block';
            document.getElementById('input-box-dist').style.display = 'inline-flex';
        }

        function updateDashboard() {
            const count = measurements.length;
            document.getElementById('disp-count').textContent = count;
            
            if (count > 0) {
                let sum = 0;
                measurements.forEach(v => sum += v);
                document.getElementById('disp-avg-r').textContent = (sum / count).toFixed(2);
            } else {
                document.getElementById('disp-avg-r').textContent = "0.00";
            }
        }

        // --- 画面遷移ロジック ---
        function showPhase(phase) {
            document.getElementById('ui-measure').style.display = 'none';
            document.getElementById('ui-input').style.display = 'none';
            document.getElementById('ui-result').style.display = 'none';

            if (phase === 'measure') {
                document.getElementById('ui-measure').style.display = 'block';
                document.getElementById('dashboard').style.display = 'flex';
            } else if (phase === 'input') {
                document.getElementById('ui-input').style.display = 'block';
                document.getElementById('dashboard').style.display = 'flex'; // ダッシュボードは残す
            } else if (phase === 'result') {
                document.getElementById('ui-result').style.display = 'block';
                document.getElementById('dashboard').style.display = 'none'; // 結果画面では消す
            }
        }

        function goToInputPhase() {
            if (measurements.length === 0) {
                alert("少なくとも1本は樹冠幅を測定してください");
                return;
            }
            showPhase('input');
        }

        function backToMeasure() {
            showPhase('measure');
        }

        // --- 最終計算 ---
        function calcResult() {
            const totalTrees = parseFloat(document.getElementById('total-trees-input').value);
            if (isNaN(totalTrees) || totalTrees <= 0) {
                alert("本数を正しく入力してください");
                return;
            }

            // 平均半径の算出
            let sumR = 0;
            measurements.forEach(v => sumR += v);
            const avgR = sumR / measurements.length;

            // 計算式: (3.141 * (樹冠幅の平均値/2)^2 * 本数) / 100
            // ※ avgR はすでに「樹冠幅/2」の値
            // ※ 3.141 を明示的に指定
            const oneTreeArea = 3.141 * Math.pow(avgR, 2);
            const totalArea = oneTreeArea * totalTrees;
            const density = totalArea / 100 * 100; // /100m2 * 100%

            // 表示
            document.getElementById('res-density').textContent = density.toFixed(1);
            
            document.getElementById('res-avg').textContent = avgR.toFixed(2);
            document.getElementById('res-area').textContent = oneTreeArea.toFixed(2);
            document.getElementById('res-count').textContent = totalTrees;
            document.getElementById('res-total-area').textContent = totalArea.toFixed(2);

            showPhase('result');
        }

        function resetAll() {
            if(!confirm("測定データをリセットして最初に戻りますか？")) return;
            measurements = [];
            updateDashboard();
            step = 0;
            document.getElementById('btn-save').style.display = 'none';
            document.getElementById('current-val-box').style.display = 'none';
            const btn = document.getElementById('btn-action');
            btn.textContent = "① 樹冠の左端";
            btn.className = "btn-blue";
            btn.style.display = 'block';
            document.getElementById('input-box-dist').style.display = 'inline-flex';

            showPhase('measure');
        }
        
        // PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
        }
    </script>
</body>
</html>
